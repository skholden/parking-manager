<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Management Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .mode-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .mode-selector h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .mode-btn.customer {
            background: linear-gradient(45deg, #48CAE4, #0096C7);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 202, 228, 0.4);
        }

        .mode-btn.attendant {
            background: linear-gradient(45deg, #F72585, #B5179E);
            color: white;
            box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-btn .icon {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
        }

        .mode-btn .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .mode-btn .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .app-interface {
            display: none;
        }

        .app-interface.active {
            display: block;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .interface-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .interface-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .interface-header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        video {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }

        canvas {
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .primary-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .primary-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            text-transform: none;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .result-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .license-plate {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 2px solid #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .payment-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .time-btn:hover, .time-btn.selected {
            background: rgba(72, 202, 228, 0.3);
            border-color: #48CAE4;
        }

        .pay-btn {
            background: linear-gradient(45deg, #06D6A0, #118AB2);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .pay-btn:hover {
            transform: translateY(-2px);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.scanning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .status.error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .quick-scan-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .scan-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scan-plate {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px;
        }

        .scan-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .scan-status.paid {
            background: #06D6A0;
            color: white;
        }

        .scan-status.unpaid {
            background: #F72585;
            color: white;
        }

        .scan-status.expired {
            background: #FFC107;
            color: #333;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            padding: 10px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .mode-buttons {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mode Selection Screen -->
        <div id="modeSelector" class="mode-selector">
            <h1>🅿️ Parking Scanner</h1>
            <div class="mode-buttons">
                <button class="mode-btn customer" onclick="selectMode('customer')">
                    <span class="icon">💳</span>
                    <div class="title">Pay for Parking</div>
                    <div class="subtitle">Scan your plate & pay</div>
                </button>
                <button class="mode-btn attendant" onclick="selectMode('attendant')">
                    <span class="icon">👮</span>
                    <div class="title">Attendant Mode</div>
                    <div class="subtitle">Verify payments</div>
                </button>
            </div>
            <p style="opacity: 0.7; font-size: 14px; text-align: center;">
                Choose your role to get started
            </p>
        </div>

        <!-- Customer Interface -->
        <div id="customerInterface" class="app-interface">
            <button class="back-btn" onclick="goBack()">← Back to Menu</button>
            <div class="interface-header">
                <h2>💳 Pay for Parking</h2>
                <p>Scan your license plate to pay for parking</p>
            </div>
            
            <div class="camera-container">
                <video id="customerVideo" autoplay playsinline></video>
                <canvas id="customerCanvas"></canvas>
            </div>
            
            <div class="controls">
                <button id="startCustomerCamera" class="secondary-btn">Start Camera</button>
                <button id="scanCustomerPlate" class="primary-btn" disabled>Scan Plate</button>
            </div>
            
            <div id="customerStatus"></div>
            
            <div id="customerResult" class="result-container" style="display: none;">
                <h3>Your License Plate:</h3>
                <div id="customerPlateText" class="license-plate"></div>
                
                <div class="payment-section">
                    <h4 style="margin-bottom: 15px;">Select Parking Duration:</h4>
                    <div class="payment-options">
                        <div class="time-btn" data-hours="1" data-cost="2.00">
                            <div>1 Hour</div>
                            <div>$2.00</div>
                        </div>
                        <div class="time-btn" data-hours="2" data-cost="3.50">
                            <div>2 Hours</div>
                            <div>$3.50</div>
                        </div>
                        <div class="time-btn" data-hours="4" data-cost="6.00">
                            <div>4 Hours</div>
                            <div>$6.00</div>
                        </div>
                        <div class="time-btn" data-hours="8" data-cost="10.00">
                            <div>All Day</div>
                            <div>$10.00</div>
                        </div>
                    </div>
                    <button class="pay-btn" id="payBtn" disabled>Select Duration to Pay</button>
                </div>
            </div>
        </div>

        <!-- Attendant Interface -->
        <div id="attendantInterface" class="app-interface">
            <button class="back-btn" onclick="goBack()">← Back to Menu</button>
            <div class="interface-header">
                <h2>👮 Attendant Mode</h2>
                <p>Quick scan to verify parking payments</p>
            </div>
            
            <div class="camera-container">
                <video id="attendantVideo" autoplay playsinline></video>
                <canvas id="attendantCanvas"></canvas>
            </div>
            
            <div class="controls">
                <button id="startAttendantCamera" class="secondary-btn">Start Camera</button>
                <button id="scanAttendantPlate" class="primary-btn" disabled>Quick Scan</button>
                <button id="clearAttendantList" class="secondary-btn">Clear List</button>
            </div>
            
            <div id="attendantStatus"></div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <span id="totalScanned" class="stat-number">0</span>
                    <span class="stat-label">Scanned</span>
                </div>
                <div class="stat-item">
                    <span id="totalPaid" class="stat-number">0</span>
                    <span class="stat-label">Paid</span>
                </div>
                <div class="stat-item">
                    <span id="totalUnpaid" class="stat-number">0</span>
                    <span class="stat-label">Unpaid</span>
                </div>
            </div>
            
            <div id="scanList" class="quick-scan-list"></div>
        </div>
    </div>

    <script>
        class ParkingScanner {
            constructor() {
                this.currentMode = null;
                this.currentVideo = null;
                this.currentCanvas = null;
                this.currentStream = null;
                this.selectedDuration = null;
                this.selectedCost = null;
                this.scannedPlates = [];
                this.stats = { scanned: 0, paid: 0, unpaid: 0 };
                
                // Mock parking database
                this.parkingDatabase = this.loadParkingDatabase();
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                // Time selection buttons
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.selectDuration(btn));
                });
                
                // Pay button
                document.getElementById('payBtn').addEventListener('click', () => this.processPayment());
            }
            
            selectDuration(btn) {
                // Remove previous selection
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                
                // Select current
                btn.classList.add('selected');
                this.selectedDuration = parseInt(btn.dataset.hours);
                this.selectedCost = parseFloat(btn.dataset.cost);
                
                const payBtn = document.getElementById('payBtn');
                payBtn.textContent = `Pay $${this.selectedCost} for ${this.selectedDuration} hour${this.selectedDuration > 1 ? 's' : ''}`;
                payBtn.disabled = false;
            }
            
            async processPayment() {
                const plateText = document.getElementById('customerPlateText').textContent;
                
                // Simulate payment processing
                this.showStatus('Processing payment...', 'scanning');
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Add to parking database
                const expirationTime = new Date();
                expirationTime.setHours(expirationTime.getHours() + this.selectedDuration);
                
                this.parkingDatabase[plateText] = {
                    paid: true,
                    expirationTime: expirationTime.toISOString(),
                    duration: this.selectedDuration,
                    cost: this.selectedCost,
                    paidAt: new Date().toISOString()
                };
                
                this.saveParkingDatabase();
                
                this.showStatus(`Payment successful! Parking expires at ${expirationTime.toLocaleTimeString()}`, 'success');
                
                // Reset for next customer
                setTimeout(() => {
                    document.getElementById('customerResult').style.display = 'none';
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
                    document.getElementById('payBtn').disabled = true;
                    document.getElementById('payBtn').textContent = 'Select Duration to Pay';
                }, 3000);
            }
            
            selectMode(mode) {
                this.currentMode = mode;
                document.getElementById('modeSelector').style.display = 'none';
                
                if (mode === 'customer') {
                    document.getElementById('customerInterface').classList.add('active');
                    this.setupCustomerMode();
                } else {
                    document.getElementById('attendantInterface').classList.add('active');
                    this.setupAttendantMode();
                }
            }
            
            setupCustomerMode() {
                this.currentVideo = document.getElementById('customerVideo');
                this.currentCanvas = document.getElementById('customerCanvas');
                
                document.getElementById('startCustomerCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('scanCustomerPlate').addEventListener('click', () => this.scanPlate('customer'));
            }
            
            setupAttendantMode() {
                this.currentVideo = document.getElementById('attendantVideo');
                this.currentCanvas = document.getElementById('attendantCanvas');
                
                document.getElementById('startAttendantCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('scanAttendantPlate').addEventListener('click', () => this.scanPlate('attendant'));
                document.getElementById('clearAttendantList').addEventListener('click', () => this.clearScanList());
                
                this.updateStats();
            }
            
            async startCamera() {
                try {
                    this.showStatus('Starting camera...', 'scanning');
                    
                    // Progressive camera constraints for better compatibility
                    const constraintOptions = [
                        // Option 1: Basic back camera
                        { video: { facingMode: 'environment' } },
                        // Option 2: Any back camera with flexible resolution
                        { video: { facingMode: { ideal: 'environment' }, width: { min: 320, ideal: 640 }, height: { min: 240, ideal: 480 } } },
                        // Option 3: Any camera with minimal constraints
                        { video: { width: { min: 320 }, height: { min: 240 } } },
                        // Option 4: Most basic request
                        { video: true }
                    ];

                    let stream = null;
                    let successOption = 0;

                    for (let i = 0; i < constraintOptions.length; i++) {
                        try {
                            console.log(`Trying camera option ${i + 1}:`, constraintOptions[i]);
                            this.showStatus(`Testing camera option ${i + 1}...`, 'scanning');
                            
                            stream = await navigator.mediaDevices.getUserMedia(constraintOptions[i]);
                            successOption = i + 1;
                            console.log(`Camera started with option ${successOption}`);
                            break;
                        } catch (error) {
                            console.log(`Option ${i + 1} failed:`, error.name);
                            if (i === constraintOptions.length - 1) throw error;
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }

                    this.currentStream = stream;
                    this.currentVideo.srcObject = stream;
                    
                    this.currentVideo.onloadedmetadata = () => {
                        this.currentCanvas.width = this.currentVideo.videoWidth;
                        this.currentCanvas.height = this.currentVideo.videoHeight;
                        
                        const startBtn = this.currentMode === 'customer' ? 
                            document.getElementById('startCustomerCamera') : 
                            document.getElementById('startAttendantCamera');
                        const scanBtn = this.currentMode === 'customer' ? 
                            document.getElementById('scanCustomerPlate') : 
                            document.getElementById('scanAttendantPlate');
                        
                        startBtn.textContent = 'Stop Camera';
                        startBtn.onclick = () => this.stopCamera();
                        scanBtn.disabled = false;
                        
                        this.showStatus(`✅ Camera ready! Option ${successOption} - ${this.currentVideo.videoWidth}x${this.currentVideo.videoHeight}`, 'success');
                    };
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    this.showStatus(`Camera error: ${error.name}. Try refreshing the page or check camera permissions.`, 'error');
                }
            }
            
            stopCamera() {
                if (this.currentStream) {
                    this.currentStream.getTracks().forEach(track => track.stop());
                    this.currentStream = null;
                }
                this.currentVideo.srcObject = null;
                
                const startBtn = this.currentMode === 'customer' ? 
                    document.getElementById('startCustomerCamera') : 
                    document.getElementById('startAttendantCamera');
                const scanBtn = this.currentMode === 'customer' ? 
                    document.getElementById('scanCustomerPlate') : 
                    document.getElementById('scanAttendantPlate');
                
                startBtn.textContent = 'Start Camera';
                startBtn.onclick = () => this.startCamera();
                scanBtn.disabled = true;
                
                this.showStatus('Camera stopped.', 'error');
            }
            
            async scanPlate(mode) {
                if (!this.currentStream) {
                    this.showStatus('Please start the camera first.', 'error');
                    return;
                }
                
                try {
                    const scanBtn = mode === 'customer' ? 
                        document.getElementById('scanCustomerPlate') : 
                        document.getElementById('scanAttendantPlate');
                    
                    scanBtn.disabled = true;
                    this.showStatus('Scanning license plate...', 'scanning');
                    
                    // Capture current frame
                    const ctx = this.currentCanvas.getContext('2d');
                    ctx.drawImage(this.currentVideo, 0, 0, this.currentCanvas.width, this.currentCanvas.height);
                    const imageData = this.currentCanvas.toDataURL('image/png');
                    
                    // Use Tesseract.js for OCR
                    const { data: { text } } = await Tesseract.recognize(
                        imageData,
                        'eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    const progress = Math.round(m.progress * 100);
                                    this.showStatus(`Processing: ${progress}%`, 'scanning');
                                }
                            }
                        }
                    );
                    
                    const plateText = this.extractLicensePlate(text);
                    
                    if (plateText) {
                        if (mode === 'customer') {
                            this.handleCustomerScan(plateText);
                        } else {
                            this.handleAttendantScan(plateText);
                        }
                        this.showStatus('License plate detected successfully!', 'success');
                    } else {
                        this.showStatus('No license plate detected. Try getting closer or adjusting the angle.', 'error');
                    }
                    
                } catch (error) {
                    console.error('OCR Error:', error);
                    this.showStatus('Error scanning image. Please try again.', 'error');
                } finally {
                    const scanBtn = mode === 'customer' ? 
                        document.getElementById('scanCustomerPlate') : 
                        document.getElementById('scanAttendantPlate');
                    scanBtn.disabled = false;
                }
            }
            
            handleCustomerScan(plateText) {
                document.getElementById('customerPlateText').textContent = plateText;
                document.getElementById('customerResult').style.display = 'block';
                
                // Check if already paid
                const existing = this.parkingDatabase[plateText];
                if (existing && existing.paid && new Date(existing.expirationTime) > new Date()) {
                    this.showStatus(`Already paid! Expires at ${new Date(existing.expirationTime).toLocaleTimeString()}`, 'success');
                }
            }
            
            handleAttendantScan(plateText) {
                const paymentStatus = this.checkPaymentStatus(plateText);
                
                // Add to scan list
                this.scannedPlates.unshift({
                    plate: plateText,
                    status: paymentStatus.status,
                    time: new Date().toLocaleTimeString(),
                    expirationTime: paymentStatus.expirationTime
                });
                
                // Keep only last 20 scans
                if (this.scannedPlates.length > 20) {
                    this.scannedPlates = this.scannedPlates.slice(0, 20);
                }
                
                this.updateScanList();
                this.updateStats();
            }
            
            checkPaymentStatus(plateText) {
                const record = this.parkingDatabase[plateText];
                
                if (!record || !record.paid) {
                    return { status: 'unpaid', expirationTime: null };
                }
                
                const expirationTime = new Date(record.expirationTime);
                const now = new Date();
                
                if (expirationTime <= now) {
                    return { status: 'expired', expirationTime: expirationTime };
                }
                
                return { status: 'paid', expirationTime: expirationTime };
            }
            
            updateScanList() {
                const scanList = document.getElementById('scanList');
                scanList.innerHTML = this.scannedPlates.map(item => `
                    <div class="scan-item">
                        <div>
                            <div class="scan-plate">${item.plate}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${item.time}</div>
                        </div>
                        <div class="scan-status ${item.status}">
                            ${item.status === 'paid' ? '✓ PAID' : 
                              item.status === 'expired' ? '⚠ EXPIRED' : '✗ UNPAID'}
                        </div>
                    </div>
                `).join('');
            }
            
            updateStats() {
                this.stats.scanned = this.scannedPlates.length;
                this.stats.paid = this.scannedPlates.filter(p => p.status === 'paid').length;
                this.stats.unpaid = this.scannedPlates.filter(p => p.status === 'unpaid' || p.status === 'expired').length;
                
                document.getElementById('totalScanned').textContent = this.stats.scanned;
                document.getElementById('totalPaid').textContent = this.stats.paid;
                document.getElementById('totalUnpaid').textContent = this.stats.unpaid;
            }
            
            clearScanList() {
                this.scannedPlates = [];
                this.updateScanList();
                this.updateStats();
                this.showStatus('Scan list cleared.', 'success');
            }
            
            extractLicensePlate(text) {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                const patterns = [
                    /^[A-Z0-9]{2,3}[-\s]?[A-Z0-9]{3,4}$/,  // ABC-1234 or AB-1234
                    /^[A-Z0-9]{6,8}$/,                      // ABC1234 (no separator)
                    /^[0-9]{1,3}[-\s]?[A-Z]{3}$/,          // 123-ABC
                    /^[A-Z]{3}[-\s]?[0-9]{3,4}$/           // ABC-123
                ];
                
                for (const line of lines) {
                    const cleaned = line.replace(/[^\w\s-]/g, '').replace(/\s+/g, '').trim().toUpperCase();
                    
                    for (const pattern of patterns) {
                        if (pattern.test(cleaned) && cleaned.length >= 4 && cleaned.length <= 10) {
                            return cleaned;
                        }
                    }
                    
                    if (/^[A-Z0-9]+$/.test(cleaned) && cleaned.length >= 4 && cleaned.length <= 8) {
                        return cleaned;
                    }
                }
                
                return null;
            }
            
            showStatus(message, type) {
                const statusDiv = this.currentMode === 'customer' ? 
                    document.getElementById('customerStatus') : 
                    document.getElementById('attendantStatus');
                
                statusDiv.innerHTML = type === 'scanning' ? 
                    `<div class="status ${type}"><span class="loading-spinner"></span>${message}</div>` :
                    `<div class="status ${type}">${message}</div>`;
            }
            
            loadParkingDatabase() {
                const stored = localStorage.getItem('parkingDatabase');
                return stored ? JSON.parse(stored) : {};
            }
            
            saveParkingDatabase() {
                localStorage.setItem('parkingDatabase', JSON.stringify(this.parkingDatabase));
            }
        }
        
        // Global functions for mode selection
        function selectMode(mode) {
            window.parkingScanner.selectMode(mode);
        }
        
        function goBack() {
            // Stop camera if running
            if (window.parkingScanner.currentStream) {
                window.parkingScanner.stopCamera();
            }
            
            // Hide all interfaces
            document.getElementById('customerInterface').classList.remove('active');
            document.getElementById('attendantInterface').classList.remove('active');
            
            // Show mode selector
            document.getElementById('modeSelector').style.display = 'block';
            
            // Reset current mode
            window.parkingScanner.currentMode = null;
        }
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.parkingScanner = new ParkingScanner();
            
            // Check if device is mobile for better UX
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                // Add mobile-specific optimizations
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.webkitTouchCallout = 'none';
                
                console.log('Mobile device detected:', {
                    isMobile: isMobile,
                    isPixel: navigator.userAgent.includes('Pixel'),
                    isFirefox: navigator.userAgent.includes('Firefox'),
                    screenSize: `${screen.width}x${screen.height}`,
                    viewportSize: `${window.innerWidth}x${window.innerHeight}`
                });
            }
        });
    </script>
</body>
</html>
